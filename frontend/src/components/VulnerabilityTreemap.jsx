import { Treemap, ResponsiveContainer, Tooltip } from "recharts";
import { AlertTriangle, AlertCircle, Info, CheckCircle } from "lucide-react";

/**
 * Vulnerability Treemap Component
 * Hierarchical view of vulnerabilities by severity
 */
export default function VulnerabilityTreemap({ vulnerabilities }) {
  if (!vulnerabilities || vulnerabilities.length === 0) {
    return (
      <div className="text-center py-12">
        <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
        <p className="text-light-200">No vulnerabilities detected! ðŸŽ‰</p>
      </div>
    );
  }

  // Helper functions - define before use
  const getSeverityColor = (severity) => {
    const colors = {
      Critical: "#DC2626",
      High: "#EA580C",
      Medium: "#F59E0B",
      Low: "#3B82F6",
    };
    return colors[severity] || "#6B7280";
  };

  const getSeverityIcon = (severity) => {
    switch (severity) {
      case "Critical":
        return <AlertTriangle className="w-4 h-4 text-red-600" />;
      case "High":
        return <AlertCircle className="w-4 h-4 text-orange-600" />;
      case "Medium":
        return <Info className="w-4 h-4 text-yellow-600" />;
      default:
        return <Info className="w-4 h-4 text-blue-600" />;
    }
  };

  // Group vulnerabilities by severity
  const grouped = vulnerabilities.reduce((acc, vuln) => {
    const severity = vuln.severity || "Low";
    if (!acc[severity]) {
      acc[severity] = [];
    }
    acc[severity].push(vuln);
    return acc;
  }, {});

  // Transform to treemap format
  const data = Object.entries(grouped).map(([severity, vulns]) => ({
    name: severity,
    size: vulns.length,
    children: vulns.map((v) => ({
      name: v.title || v.type,
      size: 1,
      severity: v.severity,
      line: v.lineNumber,
      description: v.description,
    })),
  }));

  // Flatten for treemap
  const flatData = data.map((item) => ({
    ...item,
    value: item.size,
    fill: getSeverityColor(item.name),
  }));

  const CustomContent = (props) => {
    const { x, y, width, height, name, size, fill } = props;

    if (width < 40 || height < 30) return null;

    return (
      <g>
        <rect
          x={x}
          y={y}
          width={width}
          height={height}
          fill={fill}
          stroke="#fff"
          strokeWidth={2}
          opacity={0.8}
          className="transition-opacity hover:opacity-100 cursor-pointer"
        />
        <text
          x={x + width / 2}
          y={y + height / 2 - 8}
          textAnchor="middle"
          fill="#fff"
          fontSize={14}
          fontWeight="bold"
        >
          {name}
        </text>
        <text
          x={x + width / 2}
          y={y + height / 2 + 8}
          textAnchor="middle"
          fill="#fff"
          fontSize={12}
        >
          {size} issue{size !== 1 ? "s" : ""}
        </text>
      </g>
    );
  };

  const CustomTooltip = ({ active, payload }) => {
    if (active && payload && payload[0]) {
      const data = payload[0].payload;
      return (
        <div className="bg-dark-100 rounded-lg shadow-xl border border-light-200/20 p-4 max-w-sm">
          <div className="flex items-center gap-2 mb-2">
            {getSeverityIcon(data.name)}
            <h4 className="font-bold text-white">{data.name}</h4>
          </div>
          <p className="text-sm text-light-200">
            {data.size} vulnerability{data.size !== 1 ? "ies" : ""} detected
          </p>
        </div>
      );
    }
    return null;
  };

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <div className="text-sm text-light-200">
          Total: {vulnerabilities.length} vulnerabilities
        </div>
      </div>

      <ResponsiveContainer width="100%" height={400}>
        <Treemap
          data={flatData}
          dataKey="value"
          stroke="#fff"
          fill="#8884d8"
          content={<CustomContent />}
        >
          <Tooltip content={<CustomTooltip />} />
        </Treemap>
      </ResponsiveContainer>

      {/* Summary Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {data.map((item) => (
          <div
            key={item.name}
            className="bg-dark-300 rounded-lg border border-light-200/20 p-4"
          >
            <div className="flex items-center gap-2 mb-2">
              {getSeverityIcon(item.name)}
              <span className="font-semibold text-white">{item.name}</span>
            </div>
            <div
              className="text-2xl font-bold"
              style={{ color: getSeverityColor(item.name) }}
            >
              {item.size}
            </div>
            <div className="text-xs text-light-200 mt-1">
              {((item.size / vulnerabilities.length) * 100).toFixed(1)}% of
              total
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
